<!DOCTYPE html><html data-bs-theme="light" lang="en" style="font-family: 'Bodoni Moda', serif;--bs-primary: #396639;--bs-primary-rgb: 57,102,57;--bs-secondary: #452676;--bs-secondary-rgb: 69,38,118;--bs-success: #3f7041;--bs-success-rgb: 63,112,65;--bs-info: #472b80;--bs-info-rgb: 71,43,128;--bs-warning: #368136;--bs-warning-rgb: 54,129,54;--bs-danger: #68459f;--bs-danger-rgb: 104,69,159;"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no"><title>Home - Brand</title><link rel="stylesheet" href="/assets/bootstrap/css/bootstrap.min.css?h=bec7173809e9299f24e368ea574911e3"><link rel="stylesheet" href="/assets/css/styles.min.css?h=dd28fbeaa809818e308df7a2cdc09cb7"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"></head><body style="font-family: 'Bodoni Moda', serif;"><!-- Start: Navbar Centered Links --><nav class="navbar navbar-expand-md sticky-top py-3 navbar-dark" id="mainNav" style="background: #396639;"><div class="container"><a class="navbar-brand d-flex align-items-center" href="/"><span class="bs-icon-sm bs-icon-circle bs-icon-primary shadow d-flex justify-content-center align-items-center me-2 bs-icon" style="background: #452676;width: 70px;height: 70px;"><img class="img-fluid" width="1024" height="1024" src="/assets/img/brands/ATP%20Logo.webp?h=52e2394cbfa98625d8838078258b67a7"></span><span>ATP</span></a><button data-bs-toggle="collapse" class="navbar-toggler" data-bs-target="#navcol-1"><span class="visually-hidden">Toggle navigation</span><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navcol-1"><ul class="navbar-nav mx-auto" style="font-family: 'Bodoni Moda', serif;"><li class="nav-item"><a class="nav-link" href="/index.html">HOME</a></li><li class="nav-item"><a class="nav-link" href="/tornei.html">TORNEI</a></li><li class="nav-item"><a class="nav-link" href="/giocatori.html">GIOCATORI</a></li><li class="nav-item"><a class="nav-link" href="/classifica.html">CLASSIFICA</a></li><li class="nav-item"><a class="nav-link" href="/albo.html">ALBO D'ORO</a></li><li class="nav-item"><a class="nav-link" href="/negozio.html">NEGOZIO</a></li><li class="nav-item"><a class="nav-link active" href="/sorteggi.html">SORTEGGI</a></li></ul><a class="btn btn-primary shadow" role="button" href="/donazioni.html" style="background: #68459f;font-family: 'Bodoni Moda', serif;">Aiutaci</a></div></div></nav><!-- End: Navbar Centered Links --><!-- Start: grass --><section style="transition: ease-in;height: 1100px;background: #452676;"><!-- Start: Hero Clean Reverse --><div class="container pt-4 pt-xl-5"><div>
    <!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Torneo Tennis All'Italiana (5 giocatori)</title>
  <!--
    VERSIONE MIGLIORATA
    - Calendario round-robin deterministico (metodo del cerchio) per 5 giocatori
    - 4 giorni: 3+3+3+1 partite di girone (totale 10) + 2 finali (1-2 e 3-4) nel Giorno 4
    - Nessun giocatore gioca > 2 partite al giorno
    - Inserimento risultati in pagina (best of 3 nel girone, best of 5 nelle finali)
    - Classifica dinamica con aggiornamento automatico e tie-breaker di base (head-to-head)
    - Persistenza su localStorage + export JSON per GitHub Pages (nessun backend richiesto)
  -->
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Georgia, serif; background: linear-gradient(135deg, #2c3e2c 0%, #8fbc8f 100%); min-height: 100vh; color: #2c3e2c; }
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

    .user-icon { padding: 12px 25px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.2); color: white; border-radius: 8px; cursor: pointer; font-size: 16px; transition: all .3s ease; display: flex; align-items: center; gap: 8px; box-shadow: 0 8px 32px rgba(0,0,0,.1), inset 0 1px 0 rgba(255,255,255,.2), inset 0 -1px 0 rgba(0,0,0,.1); }
    .user-icon:hover { background: rgba(255,255,255,0.15); transform: translateY(-2px); box-shadow: 0 12px 48px rgba(0,0,0,.15), inset 0 1px 0 rgba(255,255,255,.3), inset 0 -1px 0 rgba(0,0,0,.15); }

    .admin-panel { background: rgba(248,248,245,.1); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,.2); padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0,0,0,.1), inset 0 1px 0 rgba(255,255,255,.2); display: none; }
    .admin-panel.active { display: block; }
    .admin-controls { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; }

    button { background: #8fbc8f; color: white; border: none; padding: 12px 25px; border-radius: 8px; font-size: 16px; font-family: Georgia, serif; cursor: pointer; transition: all .3s ease; box-shadow: 0 3px 10px rgba(0,0,0,.2); }
    button:hover { background: #2c3e2c; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,.3); }
    button.danger { background: #dc3545; }
    button.danger:hover { background: #c82333; }

    .tabs { display: flex; gap: 10px; margin-bottom: 30px; background: rgba(248,248,245,.1); border: 1px solid rgba(255,255,255,.2); padding: 10px; border-radius: 10px; flex-wrap: wrap; justify-content: center; box-shadow: 0 8px 32px rgba(0,0,0,.1); }
    .tab { padding: 12px 25px; background: #8fbc8f; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; transition: all .3s ease; }
    .tab.active { background: #2c3e2c; }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .days-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .day-card { background: #f8f8f5; border-radius: 15px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,.1); }
    .day-card.final-day { background: linear-gradient(135deg, #ffd700, #ffed4e); border: 2px solid #ffa500; }
    .day-title { font-size: 1.5em; color: #2c3e2c; margin-bottom: 15px; text-align: center; padding: 10px; background: rgba(143,188,143,.2); border-radius: 8px; }

    .match-card { background: white; border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 3px 10px rgba(0,0,0,.1); transition: all .3s ease; }
    .match-card:hover { transform: translateY(-3px); box-shadow: 0 5px 20px rgba(0,0,0,.2); }
    .match-card.final-match { background: linear-gradient(135deg, #fff, #fffacd); border: 2px solid #ffd700; position: relative; }
    .match-card.final-match::before { content: "üèÜ"; position: absolute; top: 10px; right: 10px; font-size: 30px; }

    .match-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .match-type { font-size: .9em; color: #666; font-style: italic; }

    .players-section { display: flex; justify-content: space-between; align-items: center; gap: 20px; }
    .player-card { flex: 1; text-align: center; padding: 10px; background: rgba(143,188,143,.1); border-radius: 8px; }
    .player-avatar { width: 60px; height: 60px; background: #8fbc8f; border-radius: 50%; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; font-weight: bold; }
    .player-name { font-size: 1.1em; font-weight: bold; color: #2c3e2c; }
    .vs { font-size: 1.2em; color: #8fbc8f; font-weight: bold; }

    .score-section { margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd; }
    .sets-container { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
    .set-input { display: flex; align-items: center; gap: 5px; }
    .set-input input { width: 42px; padding: 5px; text-align: center; border: 1px solid #8fbc8f; border-radius: 5px; font-family: Georgia, serif; }
    .set-label { font-size: .9em; color: #666; }

    .standings-table { background: rgba(248,248,245,.1); border: 1px solid rgba(255,255,255,.2); border-radius: 15px; padding: 20px; overflow-x: auto; box-shadow: 0 8px 32px rgba(0,0,0,.1), inset 0 1px 0 rgba(255,255,255,.1); }
    table { width: 100%; border-collapse: collapse; background: transparent; }
    th, td { padding: 12px; text-align: center; border-bottom: 1px solid rgba(255,255,255,.1); color: #f8f8f5; text-shadow: 0 1px 2px rgba(0,0,0,.3); }
    th { background: rgba(44,62,44,.5); color: white; font-weight: bold; }
    tr:hover { background: rgba(143,188,143,.15); }
    .position-1 { background: linear-gradient(90deg, rgba(255,215,0,.4), rgba(255,237,78,.4)); font-weight: bold; }
    .position-2 { background: linear-gradient(90deg, rgba(192,192,192,.4), rgba(229,229,229,.4)); font-weight: bold; }
    .position-3 { background: linear-gradient(90deg, rgba(205,127,50,.4), rgba(218,169,95,.4)); font-weight: bold; }

    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.7); justify-content: center; align-items: center; z-index: 1000; }
    .modal.active { display: flex; }
    .modal-content { background: #f8f8f5; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,.3); max-width: 600px; width: 92%; }
    .modal-title { font-size: 1.5em; color: #2c3e2c; margin-bottom: 20px; text-align: center; }
    .password-input, .modal textarea { width: 100%; padding: 12px; border: 2px solid #8fbc8f; border-radius: 8px; font-size: 16px; margin-bottom: 20px; font-family: monospace; }
    .modal-buttons { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }

    .loading { text-align: center; padding: 20px; font-style: italic; color: #fff; }

    @media (max-width: 768px) {
      .container { padding: 10px; }
      h1 { font-size: 1.8em; }
      .days-container { grid-template-columns: 1fr; }
      .admin-controls { flex-direction: column; }
      button { width: 100%; }
      .tabs { flex-direction: column; }
      .tab { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 style="color:#fff; text-align:center; margin-bottom:15px;">Michel Annonce</h1>

    <div class="admin-panel" id="adminPanel">
      <div class="admin-controls">
        <button id="genBtn">üìÖ Genera Calendario</button>
        <button class="danger" id="resetBtn">üóëÔ∏è Reset Torneo</button>
      </div>
    </div>

    <div class="tabs">
      <button class="user-icon" id="adminBtn">
        <span style="font-size:20px;">üîê</span>
        <span>Admin</span>
      </button>
      <button id="tabMatches" class="tab active" onclick="showTab('matches', this)">üìã Partite</button>
      <button id="tabStandings" class="tab" onclick="showTab('standings', this)">üèÜ Classifica</button>
    </div>

    <div id="matches" class="tab-content active">
      <div class="days-container" id="daysContainer">
        <div class="loading">Carica i dati o genera un nuovo calendario‚Ä¶</div>
      </div>
    </div>

    <div id="standings" class="tab-content">
      <div class="standings-table">
        <table id="standingsTable">
          <thead>
            <tr>
              <th>Pos</th>
              <th>Giocatore</th>
              <th>PG</th>
              <th>V</th>
              <th>P</th>
              <th>Set V</th>
              <th>Set P</th>
              <th>Diff</th>
              <th>Punti</th>
            </tr>
          </thead>
          <tbody id="standingsBody">
            <tr><td colspan="9" class="loading">Nessun dato disponibile</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal Password Admin -->
  <div class="modal" id="adminModal">
    <div class="modal-content">
      <h3 class="modal-title">üîê Accesso Amministratore</h3>
      <input type="password" class="password-input" id="adminPassword" placeholder="Inserisci password" />
      <div class="modal-buttons">
        <button id="adminLoginBtn">Accedi</button>
        <button onclick="closeModal('adminModal')">Annulla</button>
      </div>
    </div>
  </div>

  <!-- Modal Reset -->
  <div class="modal" id="resetModal">
    <div class="modal-content">
      <h3 class="modal-title">‚ö†Ô∏è Reset Torneo</h3>
      <p style="margin-bottom: 20px; text-align: center;">Questa azione canceller√† tutti i dati. Sei sicuro?</p>
      <input type="password" class="password-input" id="resetPassword" placeholder="Inserisci password per confermare" />
      <div class="modal-buttons">
        <button class="danger" id="confirmResetBtn">Reset</button>
        <button onclick="closeModal('resetModal')">Annulla</button>
      </div>
    </div>
  </div>

  <!-- Modal Export GitHub -->
  <div class="modal" id="githubModal">
    <div class="modal-content">
      <h3 class="modal-title">üì§ Aggiornamento Dati Pubblici</h3>
      <p style="margin-bottom: 15px;">Per rendere visibili i dati a tutti:</p>
      <ol style="text-align:left; margin-bottom:15px;">
        <li>Copia il JSON dei dati qui sotto</li>
        <li>Vai su GitHub e apri/crea <code>tournament_data.json</code> nel tuo repository</li>
        <li>Clicca su "Edit" (matita)</li>
        <li>Incolla il nuovo JSON e fai commit (es. "Aggiornamento risultati")</li>
      </ol>
      <textarea id="jsonData" rows="12"></textarea>
      <div class="modal-buttons">
        <button id="copyJsonBtn">üìã Copia JSON</button>
        <button id="downloadJsonBtn">üíæ Scarica JSON</button>
        <button onclick="closeModal('githubModal')">Chiudi</button>
      </div>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const ADMIN_PASSWORD = 'tennis2024'; // cambia se vuoi
    const GITHUB_REPO = 'TUO_USERNAME/TUO_REPOSITORY'; // es. 'mario/tennis-club'
    const DATA_FILE_PATH = 'tournament_data.json';
    const PLAYERS = ['Daniele Alberti', 'Alberto Ballini', 'Pablo Brattini', 'Alessandro Scaroni', 'Andrea Zatti'];

    // ====== STATO ======
    let isAdmin = false;
    let tournamentData = { schedule: [], results: {}, standings: [] };

    // ====== UTILS ======
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    function getPlayerInitials(name) {
      return (name || '?').slice(0, 2).toUpperCase();
    }

    function showTab(tabName, btnEl) {
      $$('.tab').forEach(t => t.classList.remove('active'));
      if (btnEl) btnEl.classList.add('active');
      $$('.tab-content').forEach(c => c.classList.remove('active'));
      $('#' + tabName).classList.add('active');
    }

    function openAdminModal() { $('#adminModal').classList.add('active'); $('#adminPassword').focus(); }
    function closeModal(id) { const m = $('#' + id); if (!m) return; m.classList.remove('active'); const input = m.querySelector('input, textarea'); if (input) input.value = ''; }

    function numericOnly(el) {
      el.addEventListener('input', () => { el.value = el.value.replace(/[^0-9]/g, '').slice(0, 2); });
    }

    // ====== ROUND ROBIN ======
    function generateRoundRobin(players) {
      // Metodo del cerchio (aggiunge BYE se dispari)
      let arr = [...players];
      if (arr.length % 2 === 1) arr.push(null);
      const rounds = arr.length - 1;
      const half = arr.length / 2;
      const matches = [];
      for (let r = 0; r < rounds; r++) {
        for (let i = 0; i < half; i++) {
          const p1 = arr[i], p2 = arr[arr.length - 1 - i];
          if (p1 && p2) matches.push({ player1: p1, player2: p2, type: 'girone' });
        }
        const fixed = arr[0];
        const rot = arr.slice(1);
        rot.unshift(rot.pop());
        arr = [fixed, ...rot];
      }
      return matches; // 10 per 5 giocatori
    }

    function allocateMatchesToDays(allMatches) {
      // Capacit√† giornaliera solo per il GIRONE
      const capacity = [3, 3, 3, 1];
      const days = [[], [], [], []];
      const dayPlayerCounts = [{}, {}, {}, {}];

      for (const m of allMatches) {
        let placed = false;
        for (let d = 0; d < 4 && !placed; d++) {
          if (days[d].length >= capacity[d]) continue;
          const p1c = dayPlayerCounts[d][m.player1] || 0;
          const p2c = dayPlayerCounts[d][m.player2] || 0;
          if (p1c < 2 && p2c < 2) {
            days[d].push(m);
            dayPlayerCounts[d][m.player1] = p1c + 1;
            dayPlayerCounts[d][m.player2] = p2c + 1;
            placed = true;
          }
        }
        if (!placed) {
          // In casi rari, prova ribilanciamento semplice: metti nel giorno con pi√π spazio e <=2/giocatore
          let bestDay = -1, bestRoom = -1;
          for (let d = 0; d < 4; d++) {
            const room = capacity[d] - days[d].length;
            const p1c = (dayPlayerCounts[d][m.player1] || 0);
            const p2c = (dayPlayerCounts[d][m.player2] || 0);
            if (room > 0 && p1c < 2 && p2c < 2 && room > bestRoom) { bestRoom = room; bestDay = d; }
          }
          if (bestDay >= 0) {
            days[bestDay].push(m);
            dayPlayerCounts[bestDay][m.player1] = (dayPlayerCounts[bestDay][m.player1] || 0) + 1;
            dayPlayerCounts[bestDay][m.player2] = (dayPlayerCounts[bestDay][m.player2] || 0) + 1;
          } else {
            console.warn('Impossibile schedulare una partita rispettando tutti i vincoli:', m);
          }
        }
      }

      // Aggiungi le due finali nel Giorno 4
      days[3].push({ player1: 'TBD', player2: 'TBD', type: 'semifinale', position: '3-4' }); // match 3¬∞-4¬∞ posto
      days[3].push({ player1: 'TBD', player2: 'TBD', type: 'finale', position: '1-2' }); // finalissima

      return days;
    }

    // ====== RENDERING ======
    function renderSchedule() {
      const container = $('#daysContainer');
      if (!tournamentData.schedule.length) {
        container.innerHTML = '<div class="loading">Carica i dati o genera un nuovo calendario‚Ä¶</div>';
        return;
      }

      container.innerHTML = '';
      tournamentData.schedule.forEach((day, dayIndex) => {
        const dayCard = document.createElement('div');
        dayCard.className = dayIndex === 3 ? 'day-card final-day' : 'day-card';
        const dayTitle = document.createElement('div');
        dayTitle.className = 'day-title';
        dayTitle.textContent = dayIndex === 3 ? 'üèÜ Giorno Finale' : `Giorno ${dayIndex + 1}`;
        dayCard.appendChild(dayTitle);

        day.forEach((match, matchIndex) => {
          const matchId = `day${dayIndex}-match${matchIndex}`;
          const card = createMatchCard(match, matchId);
          dayCard.appendChild(card);
        });

        container.appendChild(dayCard);
      });
    }

    function createMatchCard(match, matchId) {
      const isFinal = (match.type === 'finale' || match.type === 'semifinale');
      const card = document.createElement('div');
      card.className = isFinal ? 'match-card final-match' : 'match-card';
      card.setAttribute('data-match-id', matchId);

      const header = document.createElement('div');
      header.className = 'match-header';
      const matchType = document.createElement('div');
      matchType.className = 'match-type';
      if (match.type === 'finale') matchType.textContent = 'üèÜ Finalissima (best of 5)';
      else if (match.type === 'semifinale') matchType.textContent = 'ü•â 3¬∞-4¬∞ posto (best of 5)';
      else matchType.textContent = 'Girone (best of 3)';
      header.appendChild(matchType);
      card.appendChild(header);

      const playersSection = document.createElement('div');
      playersSection.className = 'players-section';

      // Player 1
      const p1 = document.createElement('div'); p1.className = 'player-card';
      const p1a = document.createElement('div'); p1a.className = 'player-avatar'; p1a.textContent = match.player1 === 'TBD' ? '?' : getPlayerInitials(match.player1);
      const p1n = document.createElement('div'); p1n.className = 'player-name'; p1n.textContent = match.player1;
      p1.appendChild(p1a); p1.appendChild(p1n);

      // VS
      const vs = document.createElement('div'); vs.className = 'vs'; vs.textContent = 'VS';

      // Player 2
      const p2 = document.createElement('div'); p2.className = 'player-card';
      const p2a = document.createElement('div'); p2a.className = 'player-avatar'; p2a.textContent = match.player2 === 'TBD' ? '?' : getPlayerInitials(match.player2);
      const p2n = document.createElement('div'); p2n.className = 'player-name'; p2n.textContent = match.player2;
      p2.appendChild(p2a); p2.appendChild(p2n);

      playersSection.appendChild(p1); playersSection.appendChild(vs); playersSection.appendChild(p2);
      card.appendChild(playersSection);

      const existingResult = tournamentData.results[matchId] || {};
      const hasAnySet = Object.keys(existingResult).some(k => k.startsWith('set'));

      if (match.player1 !== 'TBD' && match.player2 !== 'TBD') {
        if (isAdmin) card.appendChild(createEditableScoreSection(match, matchId, existingResult));
        else if (hasAnySet) card.appendChild(createReadOnlyScoreSection(existingResult));
      }

      return card;
    }

    function createEditableScoreSection(match, matchId, existingResult) {
      const scoreSection = document.createElement('div'); scoreSection.className = 'score-section';
      const setsContainer = document.createElement('div'); setsContainer.className = 'sets-container';
      const maxSets = (match.type === 'finale' || match.type === 'semifinale') ? 5 : 3;

      for (let i = 1; i <= maxSets; i++) {
        const wrap = document.createElement('div'); wrap.className = 'set-input';
        const label = document.createElement('span'); label.className = 'set-label'; label.textContent = `Set ${i}:`;
        const in1 = document.createElement('input'); in1.type = 'text'; in1.placeholder = '0'; in1.value = (existingResult[`set${i}`] || '').split('-')[0] || ''; in1.dataset.matchId = matchId; in1.dataset.setNumber = i; in1.dataset.playerNumber = '1'; numericOnly(in1);
        const dash = document.createElement('span'); dash.textContent = '-';
        const in2 = document.createElement('input'); in2.type = 'text'; in2.placeholder = '0'; in2.value = (existingResult[`set${i}`] || '').split('-')[1] || ''; in2.dataset.matchId = matchId; in2.dataset.setNumber = i; in2.dataset.playerNumber = '2'; numericOnly(in2);

        let t; const onChange = () => { clearTimeout(t); t = setTimeout(() => saveMatchResult(matchId, match), 350); };
        in1.addEventListener('input', onChange); in2.addEventListener('input', onChange);

        wrap.appendChild(label); wrap.appendChild(in1); wrap.appendChild(dash); wrap.appendChild(in2);
        setsContainer.appendChild(wrap);
      }
      scoreSection.appendChild(setsContainer);
      return scoreSection;
    }

    function createReadOnlyScoreSection(result) {
      const scoreSection = document.createElement('div'); scoreSection.className = 'score-section';
      const setsContainer = document.createElement('div'); setsContainer.className = 'sets-container'; setsContainer.style.justifyContent = 'center';
      for (let i = 1; i <= 5; i++) {
        if (result[`set${i}`]) {
          const tag = document.createElement('div');
          tag.style.cssText = 'padding: 5px 10px; background: rgba(255,255,255,0.2); border-radius: 5px; margin: 0 5px;';
          tag.innerHTML = `<strong>Set ${i}:</strong> ${result[`set${i}`]}`;
          setsContainer.appendChild(tag);
        }
      }
      scoreSection.appendChild(setsContainer);
      return scoreSection;
    }

    // ====== RISULTATI / CLASSIFICA ======
    function saveMatchResult(matchId, match) {
      const card = document.querySelector(`[data-match-id="${matchId}"]`);
      if (!card) return;
      const result = { player1: match.player1, player2: match.player2, type: match.type };

      let valid = false;
      const maxSets = (match.type === 'finale' || match.type === 'semifinale') ? 5 : 3;
      for (let i = 1; i <= maxSets; i++) {
        const s1 = card.querySelector(`input[data-set-number="${i}"][data-player-number="1"]`);
        const s2 = card.querySelector(`input[data-set-number="${i}"][data-player-number="2"]`);
        if (!s1 || !s2) continue;
        const a = s1.value.trim(); const b = s2.value.trim();
        if (a !== '' && b !== '') { result[`set${i}`] = `${a}-${b}`; valid = true; }
      }

      if (valid) {
        tournamentData.results[matchId] = result;
      } else {
        delete tournamentData.results[matchId];
      }

      updateStandings();
      saveData();
      // Rerender per mostrare se l'utente non admin deve vedere solo read-only
      if (!isAdmin) renderSchedule();
    }

    function computeSetWins(result) {
      const bestOf = (result.type === 'finale' || result.type === 'semifinale') ? 5 : 3;
      const need = Math.ceil(bestOf / 2);
      let p1 = 0, p2 = 0, played = 0;
      for (let i = 1; i <= bestOf; i++) {
        if (!result[`set${i}`]) break;
        const [a, b] = result[`set${i}`].split('-').map(Number);
        if (Number.isFinite(a) && Number.isFinite(b) && a !== b) {
          played++;
          if (a > b) p1++; else p2++;
          if (p1 === need || p2 === need) break; // vincitore deciso
        }
      }
      return { p1, p2, played };
    }

    function updateStandings() {
      const standings = {};
      PLAYERS.forEach(name => standings[name] = { name, played: 0, won: 0, lost: 0, setsWon: 0, setsLost: 0, points: 0 });

      // calcola statistiche dal girone
      Object.entries(tournamentData.results).forEach(([id, res]) => {
        if (res.type !== 'girone') return;
        if (!res.player1 || !res.player2) return;
        const { p1, p2, played } = computeSetWins(res);
        if (played === 0) return;
        const A = standings[res.player1], B = standings[res.player2];
        if (!A || !B) return;
        A.played++; B.played++;
        A.setsWon += p1; A.setsLost += p2; B.setsWon += p2; B.setsLost += p1;
        if (p1 > p2) { A.won++; B.lost++; A.points += 3; }
        else if (p2 > p1) { B.won++; A.lost++; B.points += 3; }
      });

      let arr = Object.values(standings);
      // Tie-breaker: punti, diff set, set vinti, head-to-head se esattamente 2 pari
      arr.sort((a, b) => {
        if (b.points !== a.points) return b.points - a.points;
        const da = a.setsWon - a.setsLost, db = b.setsWon - b.setsLost;
        if (db !== da) return db - da;
        if (b.setsWon !== a.setsWon) return b.setsWon - a.setsWon;
        // Head-to-head
        const h2h = headToHead(a.name, b.name);
        if (h2h !== 0) return -h2h; // h2h = 1 se vince a, -1 se vince b -> invertito perch√© sort disc
        return a.name.localeCompare(b.name);
      });

      updateFinals(arr);
      renderStandings(arr);
      tournamentData.standings = arr;
    }

    function headToHead(nameA, nameB) {
      // ritorna 1 se A ha battuto B, -1 se B ha battuto A, 0 altrimenti/indeterminato
      for (const [id, res] of Object.entries(tournamentData.results)) {
        if (res.type !== 'girone') continue;
        const p = [res.player1, res.player2];
        if (!p.includes(nameA) || !p.includes(nameB)) continue;
        const { p1, p2 } = computeSetWins(res);
        if (res.player1 === nameA && res.player2 === nameB) {
          if (p1 > p2) return 1; if (p2 > p1) return -1;
        }
        if (res.player1 === nameB && res.player2 === nameA) {
          if (p1 > p2) return -1; if (p2 > p1) return 1;
        }
      }
      return 0;
    }

    function renderStandings(arr) {
      const tbody = $('#standingsBody');
      tbody.innerHTML = '';
      const allZero = arr.every(p => p.played === 0);
      if (allZero) { tbody.innerHTML = '<tr><td colspan="9" class="loading">Nessun risultato inserito</td></tr>'; return; }

      arr.forEach((p, i) => {
        const tr = document.createElement('tr');
        if (i === 0) tr.className = 'position-1'; else if (i === 1) tr.className = 'position-2'; else if (i === 2) tr.className = 'position-3';
        const diff = p.setsWon - p.setsLost; const diffDisp = diff > 0 ? '+' + diff : String(diff);
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td>${p.name}</td>
          <td>${p.played}</td>
          <td>${p.won}</td>
          <td>${p.lost}</td>
          <td>${p.setsWon}</td>
          <td>${p.setsLost}</td>
          <td>${diffDisp}</td>
          <td><strong>${p.points}</strong></td>`;
        tbody.appendChild(tr);
      });
    }

    function updateFinals(standingsArr) {
      if (tournamentData.schedule.length !== 4) return;
      const day4 = tournamentData.schedule[3];
      if (!day4 || day4.length < 3) return;

      // Conta partite di girone con vincitore valido
      let completed = 0;
      for (const [id, res] of Object.entries(tournamentData.results)) {
        if (res.type !== 'girone') continue;
        const { p1, p2, played } = computeSetWins(res);
        if (played > 0 && p1 !== p2) completed++;
      }

      if (completed === 10 && standingsArr.length >= 4) {
        // Ordine Giorno 4: ultima del girone (se presente), poi 3-4, poi 1-2
        // Trova gli indici delle finali nel giorno 4
        const idx34 = day4.findIndex(m => m.type === 'semifinale');
        const idx12 = day4.findIndex(m => m.type === 'finale');
        if (idx34 >= 0) {
          day4[idx34].player1 = standingsArr[2].name;
          day4[idx34].player2 = standingsArr[3].name;
        }
        if (idx12 >= 0) {
          day4[idx12].player1 = standingsArr[0].name;
          day4[idx12].player2 = standingsArr[1].name;
        }
        renderSchedule(); // per mostrare i nomi aggiornati nelle carte finali
      }
    }

    // ====== STORAGE / EXPORT ======
    async function saveData() {
      try {
        localStorage.setItem('tournamentData', JSON.stringify(tournamentData));
      } catch (e) { console.error('Errore salvataggio:', e); }
    }

    async function loadData() {
      // prova da GitHub raw, poi fallback a localStorage
      try {
        const resp = await fetch(`https://raw.githubusercontent.com/${GITHUB_REPO}/main/${DATA_FILE_PATH}`, { cache: 'no-store' });
        if (resp.ok) {
          const data = await resp.json();
          if (data && data.schedule) tournamentData = data;
        } else {
          throw new Error('File non trovato su GitHub');
        }
      } catch (err) {
        const local = localStorage.getItem('tournamentData');
        if (local) tournamentData = JSON.parse(local);
      }
      renderSchedule();
      updateStandings();
    }

    function openExportModal() {
      const modal = $('#githubModal');
      $('#jsonData').value = JSON.stringify(tournamentData, null, 2);
      modal.classList.add('active');
    }

    function downloadJSON() {
      const dataStr = JSON.stringify(tournamentData, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'tournament_data.json'; a.click();
      URL.revokeObjectURL(url);
    }

    function copyToClipboard() {
      const t = $('#jsonData'); t.select(); document.execCommand('copy');
    }

    // ====== AZIONI ADMIN ======
    function generateSchedule() {
      if (!isAdmin) { alert('Accesso negato!'); return; }
      const rr = generateRoundRobin(PLAYERS); // 10 partite
      const schedule = allocateMatchesToDays(rr); // 4 giorni
      tournamentData.schedule = schedule;
      tournamentData.results = {};
      saveData();
      renderSchedule();
      updateStandings();
    }

    function openResetModal() { if (!isAdmin) { alert('Accesso negato!'); return; } $('#resetModal').classList.add('active'); }
    function confirmReset() {
      const pw = $('#resetPassword').value;
      if (pw === ADMIN_PASSWORD) {
        tournamentData = { schedule: [], results: {}, standings: [] };
        saveData(); closeModal('resetModal'); renderSchedule(); updateStandings(); alert('Torneo resettato con successo!');
      } else alert('Password errata!');
    }

    function checkAdminPassword() {
      const pw = $('#adminPassword').value;
      if (pw === ADMIN_PASSWORD) { isAdmin = true; $('#adminPanel').classList.add('active'); closeModal('adminModal'); renderSchedule(); }
      else alert('Password errata!');
    }

    // ====== EVENTI ======
    window.addEventListener('load', () => { loadData(); });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') $$('.modal').forEach(m => m.classList.remove('active'));
      if (e.key === 'Enter' && $('#adminModal').classList.contains('active')) checkAdminPassword();
    });

    // Bottoni
    $('#adminBtn').addEventListener('click', openAdminModal);
    $('#genBtn').addEventListener('click', generateSchedule);
    $('#resetBtn').addEventListener('click', openResetModal);
    $('#confirmResetBtn').addEventListener('click', confirmReset);
    $('#adminLoginBtn').addEventListener('click', checkAdminPassword);
    $('#exportBtn').addEventListener('click', () => { if (!isAdmin) { alert('Accesso negato!'); return; } openExportModal(); });
    $('#copyJsonBtn').addEventListener('click', copyToClipboard);
    $('#downloadJsonBtn').addEventListener('click', downloadJSON);
  </script>
</body>
</html>

</div></div><!-- End: Hero Clean Reverse --></section><!-- End: grass --><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script><script src="/assets/js/script.min.js?h=9a9b12d9479055b6ccf322643488f6dd"></script></body></html>