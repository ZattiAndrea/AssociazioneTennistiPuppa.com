<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torneo All'Italiana - Tennis Club</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background-color: #f8f8f5;
            color: #2c3e2c;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: #2c3e2c;
            color: white;
            padding: 30px 0;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            font-size: 2.5rem;
            font-weight: normal;
            letter-spacing: 2px;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.1rem;
            color: #8fbc8f;
            font-style: italic;
        }

        /* Sezione Classifica */
        .standings-section {
            background-color: white;
            padding: 30px;
            margin: 30px 0;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }

        .standings-title {
            text-align: center;
            font-size: 2rem;
            color: #2c3e2c;
            margin-bottom: 20px;
            letter-spacing: 1px;
        }

        .standings-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .standings-table th {
            background-color: #2c3e2c;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: normal;
            letter-spacing: 1px;
        }

        .standings-table td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .standings-table tr:hover {
            background-color: #f5f5f5;
        }

        .position-1 {
            background-color: #ffd700;
            font-weight: bold;
        }

        .position-2 {
            background-color: #c0c0c0;
        }

        .position-3 {
            background-color: #cd7f32;
        }

        .admin-icon {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            background-color: #2c3e2c;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .admin-icon:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .admin-icon svg {
            width: 25px;
            height: 25px;
            fill: white;
        }

        .admin-section {
            background-color: #fff;
            padding: 20px;
            margin: 30px 0;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            display: none;
        }

        .admin-section.active {
            display: block;
        }

        .admin-login {
            position: fixed;
            top: 80px;
            left: 20px;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            display: none;
            z-index: 999;
        }

        .admin-login.active {
            display: block;
        }

        .admin-login input {
            padding: 10px 20px;
            font-size: 1rem;
            border: 2px solid #2c3e2c;
            border-radius: 5px;
            margin-bottom: 10px;
            width: 100%;
        }

        .btn {
            background-color: #2c3e2c;
            color: white;
            padding: 10px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background-color: #1a2b1a;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .btn-generate {
            background-color: #8fbc8f;
            margin: 20px auto;
            display: block;
        }

        .btn-generate:hover {
            background-color: #6fa96f;
        }

        .btn-reset {
            background-color: #dc3545;
            margin: 20px auto;
            display: block;
        }

        .btn-reset:hover {
            background-color: #c82333;
        }

        .day-section {
            margin: 40px 0;
        }

        .day-header {
            background-color: #8fbc8f;
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 1.3rem;
            border-radius: 10px 10px 0 0;
            letter-spacing: 1px;
        }

        .matches-container {
            background-color: white;
            padding: 20px;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }

        .match {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 30px 0;
            padding: 20px;
            background-color: #fafafa;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
        }

        .match:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .player-card {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-width: 150px;
        }

        .player-photo {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: #e0e0e0;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #8fbc8f;
            border: 3px solid #8fbc8f;
        }

        .player-name {
            font-size: 1.1rem;
            font-weight: bold;
            color: #2c3e2c;
        }

        .vs {
            font-size: 2rem;
            font-weight: bold;
            color: #8fbc8f;
            margin: 0 30px;
        }

        .score-section {
            margin-top: 20px;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .set-score {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .set-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
        }

        .score-input {
            width: 80px;
            padding: 8px;
            text-align: center;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .score-input:focus {
            border-color: #8fbc8f;
            outline: none;
        }

        .score-input:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }

        .final-day {
            background-color: #ffd700;
            color: #2c3e2c;
        }

        .special-match {
            background-color: #fff8dc;
            border: 3px solid #ffd700;
        }

        .final-match {
            background: linear-gradient(135deg, #fff8dc 0%, #fafad2 100%);
            border: 3px solid #ffd700;
            position: relative;
            overflow: hidden;
        }

        .final-match::before {
            content: 'üèÜ';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 2rem;
            opacity: 0.3;
        }

        @media (max-width: 768px) {
            .match {
                flex-direction: column;
            }

            .vs {
                margin: 20px 0;
            }

            .score-section {
                flex-wrap: wrap;
            }

            .standings-table {
                font-size: 0.9rem;
            }

            .standings-table th, .standings-table td {
                padding: 10px 5px;
            }
        }

        .loading {
            text-align: center;
            font-size: 1.2rem;
            color: #8fbc8f;
            margin: 50px 0;
        }
    </style>
</head>
<body>
    <header>
        <h1>TORNEO ALL'ITALIANA</h1>
        <p class="subtitle">Tennis Club - Campionato Amici</p>
    </header>

    <div class="container">
        <!-- Icona Admin nascosta -->
        <div class="admin-icon" onclick="toggleAdminLogin()">
            <svg viewBox="0 0 24 24">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
        </div>

        <!-- Sezione Classifica -->
        <div class="standings-section" id="standingsSection" style="display: none;">
            <h2 class="standings-title">CLASSIFICA GENERALE</h2>
            <table class="standings-table">
                <thead>
                    <tr>
                        <th>Pos.</th>
                        <th>Giocatore</th>
                        <th>Partite</th>
                        <th>Vinte</th>
                        <th>Perse</th>
                        <th>Set Vinti</th>
                        <th>Set Persi</th>
                        <th>Diff. Set</th>
                        <th>Punti</th>
                    </tr>
                </thead>
                <tbody id="standingsBody">
                </tbody>
            </table>
        </div>

        <div class="admin-login" id="adminLogin">
            <input type="password" id="adminPassword" placeholder="Password amministratore">
            <button class="btn" onclick="checkAdminAccess()">Accedi</button>
        </div>

        <div class="admin-section" id="adminSection">
            <h2>Pannello Amministratore</h2>
            <p>Benvenuto amministratore! Puoi generare il calendario degli incontri o resettare tutto.</p>
            <button class="btn btn-generate" onclick="generateMatches()">Genera Calendario Incontri</button>
            <button class="btn btn-reset" onclick="resetTournament()">Reset Completo Torneo</button>
        </div>

        <div id="tournamentSchedule"></div>
    </div>

    <script>
        const players = [
            { id: 1, name: 'Giocatore 1', initial: 'G1' },
            { id: 2, name: 'Giocatore 2', initial: 'G2' },
            { id: 3, name: 'Giocatore 3', initial: 'G3' },
            { id: 4, name: 'Giocatore 4', initial: 'G4' },
            { id: 5, name: 'Giocatore 5', initial: 'G5' }
        ];

        let isAdmin = false;
        let matchesGenerated = false;
        let matchesData = [];

        // Carica i dati salvati al caricamento della pagina
        window.onload = function() {
            const savedMatches = localStorage.getItem('tennisMatches');
            const savedMatchesData = localStorage.getItem('tennisMatchesData');
            
            if (savedMatches && savedMatchesData) {
                document.getElementById('tournamentSchedule').innerHTML = savedMatches;
                matchesData = JSON.parse(savedMatchesData);
                matchesGenerated = true;
                setupScoreInputs();
                updateStandings();
                document.getElementById('standingsSection').style.display = 'block';
            }
        };

        function toggleAdminLogin() {
            const adminLogin = document.getElementById('adminLogin');
            adminLogin.classList.toggle('active');
        }

        function checkAdminAccess() {
            const password = document.getElementById('adminPassword').value;
            // Password segreta (puoi cambiarla)
            if (password === 'wimbledon2024') {
                isAdmin = true;
                document.getElementById('adminSection').classList.add('active');
                document.getElementById('adminLogin').classList.remove('active');
                setupScoreInputs();
            } else {
                alert('Password errata!');
            }
        }

        function resetTournament() {
            if (confirm('Sei sicuro di voler cancellare TUTTO? Questa azione eliminer√† il calendario e tutti i risultati inseriti.')) {
                const confirmPassword = prompt('Inserisci la password admin per confermare il reset completo:');
                
                if (confirmPassword === 'wimbledon2024') {
                    // Cancella tutti i dati dal localStorage
                    const keysToRemove = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && (key.includes('match_') || key.includes('third_place') || key.includes('final') || 
                                   key.includes('_set') || key === 'tennisMatches' || key === 'tennisMatchesData')) {
                            keysToRemove.push(key);
                        }
                    }
                    
                    keysToRemove.forEach(key => localStorage.removeItem(key));
                    
                    // Reset variabili
                    matchesGenerated = false;
                    matchesData = [];
                    
                    // Pulisci l'HTML
                    document.getElementById('tournamentSchedule').innerHTML = '';
                    document.getElementById('standingsSection').style.display = 'none';
                    document.getElementById('standingsBody').innerHTML = '';
                    
                    alert('Torneo resettato con successo! Ora puoi generare un nuovo calendario.');
                } else {
                    alert('Password errata! Reset annullato.');
                }
            }
        }

        function generateAllMatches() {
            const matches = [];
            for (let i = 0; i < players.length; i++) {
                for (let j = i + 1; j < players.length; j++) {
                    matches.push({
                        player1: players[i],
                        player2: players[j],
                        id: `match_${players[i].id}_${players[j].id}`
                    });
                }
            }
            return shuffleArray(matches);
        }

        function shuffleArray(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function canPlayerPlay(player, dayMatches, playerMatchCount) {
            const dayCount = dayMatches.filter(m => 
                m.player1.id === player.id || m.player2.id === player.id
            ).length;
            return dayCount < 2 && playerMatchCount[player.id] < 10;
        }

        function distributeMatches(matches) {
            const days = [[], [], [], []]; // 4 giorni ora
            const playerMatchCount = {};
            players.forEach(p => playerMatchCount[p.id] = 0);
            
            let remainingMatches = [...matches];
            
            // Distribuisci le prime 9 partite nei primi 3 giorni
            for (let dayIndex = 0; dayIndex < 3; dayIndex++) {
                let matchesAdded = 0;
                for (let i = remainingMatches.length - 1; i >= 0 && matchesAdded < 3; i--) {
                    const match = remainingMatches[i];
                    if (canPlayerPlay(match.player1, days[dayIndex], playerMatchCount) &&
                        canPlayerPlay(match.player2, days[dayIndex], playerMatchCount)) {
                        days[dayIndex].push(match);
                        playerMatchCount[match.player1.id]++;
                        playerMatchCount[match.player2.id]++;
                        remainingMatches.splice(i, 1);
                        matchesAdded++;
                    }
                }
            }
            
            // L'ultima partita va nel giorno finale
            if (remainingMatches.length > 0) {
                days[3].push(remainingMatches[0]);
            }

            return days;
        }

        function generateMatches() {
            if (matchesGenerated && !confirm('Sei sicuro di voler rigenerare il calendario? Questo canceller√† tutti i risultati inseriti.')) {
                return;
            }

            const allMatches = generateAllMatches();
            const distributedDays = distributeMatches(allMatches);
            matchesData = allMatches;
            
            let html = '';
            
            // Giorni normali (1-3)
            for (let i = 0; i < 3; i++) {
                html += `
                    <div class="day-section">
                        <div class="day-header">GIORNO ${i + 1}</div>
                        <div class="matches-container">
                `;
                
                distributedDays[i].forEach((match) => {
                    html += createMatchHTML(match, match.id);
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            // Giorno finale
            html += `
                <div class="day-section">
                    <div class="day-header final-day">GIORNO FINALE</div>
                    <div class="matches-container">
            `;
            
            // Ultima partita del girone
            if (distributedDays[3].length > 0) {
                html += createMatchHTML(distributedDays[3][0], distributedDays[3][0].id);
            }
            
            // Scontro 3¬∞ e 4¬∞ posto (5 set)
            html += createMatchHTML(
                { player1: { name: '3¬∞ Classificato', initial: '3¬∞' }, 
                  player2: { name: '4¬∞ Classificato', initial: '4¬∞' } },
                'third_place',
                'special-match',
                'Scontro 3¬∞ e 4¬∞ Posto',
                5
            );
            
            // Finalissima (5 set)
            html += createMatchHTML(
                { player1: { name: 'Finalista 1', initial: 'F1' }, 
                  player2: { name: 'Finalista 2', initial: 'F2' } },
                'final',
                'final-match',
                'FINALISSIMA',
                5
            );
            
            html += `
                    </div>
                </div>
            `;
            
            document.getElementById('tournamentSchedule').innerHTML = html;
            document.getElementById('standingsSection').style.display = 'block';
            matchesGenerated = true;
            
            // Salva in localStorage
            localStorage.setItem('tennisMatches', html);
            localStorage.setItem('tennisMatchesData', JSON.stringify(matchesData));
            
            setupScoreInputs();
            updateStandings();
        }

        function createMatchHTML(match, matchId, specialClass = '', title = '', sets = 3) {
            let setInputs = '';
            for (let i = 1; i <= sets; i++) {
                setInputs += `
                    <div class="set-score">
                        <div class="set-label">Set ${i}</div>
                        <input type="text" class="score-input" id="${matchId}_set${i}" 
                               placeholder="0-0" onchange="saveScore('${matchId}_set${i}', '${matchId}')">
                    </div>
                `;
            }
            
            return `
                <div class="match ${specialClass}">
                    <div style="width: 100%;">
                        ${title ? `<h3 style="text-align: center; margin-bottom: 20px; color: #2c3e2c;">${title}</h3>` : ''}
                        <div style="display: flex; align-items: center; justify-content: center;">
                            <div class="player-card">
                                <div class="player-photo">${match.player1.initial}</div>
                                <div class="player-name">${match.player1.name}</div>
                            </div>
                            <div class="vs">VS</div>
                            <div class="player-card">
                                <div class="player-photo">${match.player2.initial}</div>
                                <div class="player-name">${match.player2.name}</div>
                            </div>
                        </div>
                        <div class="score-section">
                            ${setInputs}
                        </div>
                    </div>
                </div>
            `;
        }

        function setupScoreInputs() {
            const inputs = document.querySelectorAll('.score-input');
            inputs.forEach(input => {
                // Carica i punteggi salvati
                const savedScore = localStorage.getItem(input.id);
                if (savedScore) {
                    input.value = savedScore;
                }
                
                // Abilita/disabilita in base allo stato admin
                input.disabled = !isAdmin;
            });
        }

        function saveScore(inputId, matchId) {
            const input = document.getElementById(inputId);
            localStorage.setItem(inputId, input.value);
            
            // Salva anche l'HTML aggiornato
            const scheduleHTML = document.getElementById('tournamentSchedule').innerHTML;
            localStorage.setItem('tennisMatches', scheduleHTML);
            
            // Aggiorna la classifica
            updateStandings();
        }

        function parseScore(scoreString) {
            if (!scoreString || scoreString.trim() === '') return null;
            const parts = scoreString.split('-');
            if (parts.length !== 2) return null;
            return {
                player1: parseInt(parts[0]) || 0,
                player2: parseInt(parts[1]) || 0
            };
        }

        function calculateMatchResult(matchId) {
            const sets = [];
            for (let i = 1; i <= 5; i++) {
                const scoreInput = document.getElementById(`${matchId}_set${i}`);
                if (scoreInput && scoreInput.value) {
                    const score = parseScore(scoreInput.value);
                    if (score) sets.push(score);
                }
            }
            
            if (sets.length === 0) return null;
            
            let player1Sets = 0;
            let player2Sets = 0;
            let player1Games = 0;
            let player2Games = 0;
            
            sets.forEach(set => {
                if (set.player1 > set.player2) player1Sets++;
                else if (set.player2 > set.player1) player2Sets++;
                player1Games += set.player1;
                player2Games += set.player2;
            });
            
            return {
                winner: player1Sets > player2Sets ? 1 : (player2Sets > player1Sets ? 2 : 0),
                setsWon: { player1: player1Sets, player2: player2Sets },
                gamesWon: { player1: player1Games, player2: player2Games }
            };
        }

        function updateStandings() {
            const standings = {};
            
            // Inizializza la classifica per ogni giocatore
            players.forEach(player => {
                standings[player.id] = {
                    name: player.name,
                    played: 0,
                    won: 0,
                    lost: 0,
                    setsWon: 0,
                    setsLost: 0,
                    setsDiff: 0,
                    points: 0
                };
            });
            
            // Calcola i risultati per ogni partita
            matchesData.forEach(match => {
                const result = calculateMatchResult(match.id);
                if (result && result.winner !== 0) {
                    const p1 = match.player1.id;
                    const p2 = match.player2.id;
                    
                    standings[p1].played++;
                    standings[p2].played++;
                    
                    if (result.winner === 1) {
                        standings[p1].won++;
                        standings[p1].points += 3;
                        standings[p2].lost++;
                    } else {
                        standings[p2].won++;
                        standings[p2].points += 3;
                        standings[p1].lost++;
                    }
                    
                    standings[p1].setsWon += result.setsWon.player1;
                    standings[p1].setsLost += result.setsWon.player2;
                    standings[p2].setsWon += result.setsWon.player2;
                    standings[p2].setsLost += result.setsWon.player1;
                }
            });
            
            // Calcola la differenza set
            Object.values(standings).forEach(player => {
                player.setsDiff = player.setsWon - player.setsLost;
            });
            
            // Ordina la classifica
            const sortedStandings = Object.values(standings).sort((a, b) => {
                if (b.points !== a.points) return b.points - a.points;
                if (b.setsDiff !== a.setsDiff) return b.setsDiff - a.setsDiff;
                return b.setsWon - a.setsWon;
            });
            
            // Aggiorna la tabella HTML
            const tbody = document.getElementById('standingsBody');
            tbody.innerHTML = '';
            
            sortedStandings.forEach((player, index) => {
                const row = document.createElement('tr');
                if (index === 0) row.className = 'position-1';
                else if (index === 1) row.className = 'position-2';
                else if (index === 2) row.className = 'position-3';
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${player.name}</td>
                    <td>${player.played}</td>
                    <td>${player.won}</td>
                    <td>${player.lost}</td>
                    <td>${player.setsWon}</td>
                    <td>${player.setsLost}</td>
                    <td>${player.setsDiff > 0 ? '+' : ''}${player.setsDiff}</td>
                    <td><strong>${player.points}</strong></td>
                `;
                tbody.appendChild(row);
            });
        }
    </script>
</body>
</html>